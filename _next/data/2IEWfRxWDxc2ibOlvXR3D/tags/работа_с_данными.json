{"pageProps":{"allPosts":[{"title":"Экспортируем нужные нам данные из openStreetMap","date":"2020-07-05T14:15:07.322Z","slug":"exporting_data_form_osm","author":{"name":"Roman A. Nosov","picture":"https://avatars3.githubusercontent.com/u/21103635?s=120&v=4","url":"https://github.com/JustAddAcid"},"content":"\nИногда возникает ситуация, в которой нам жизненно необходимо получить структурированные геоданные для своих проектов. Но где их искать? Делать на коленке парсер *google maps*?\n\nНа самом деле нет — всё куда прозаичнее. Их можно без зазрения совести скоммуниздить из прекрасного проекта *openStreetMaps*, попутно дополнив и исправив текущие данные в их базах.\n\n**Краткая справка для тех, кто в танке:** *openStreetMaps* (или кратко *OSM*) — *open source* картографический проект, где каждый пользователь может чуть-чуть дорисовать карту. И по принципу \"с миру по нитке\" собирается свободная и бесплатная карта мира. (как с википедией, только карта)\n\n## Процесс раскулачивания геосервиса запущен\n![Псс, парень, не хочешь немного геоданных?](/assets/blog/exporting_data_form_osm/meme.jpg)\n\nИтак, в моём конкретном случае, мне нужно получить данные **по всем железнодорожным станциям России**: название, её код в какой-нибудь международной классификации + координаты. У вас это могут любые другие данные, принцип получения от этого толком не изменяется. \n\nДля вытаскивания небольших данных из *OSM* есть онлайновый инструмент, который позволяет делать запросы и получать результат в *JSON*.\n\nНо лично для меня этот язык запросов выглядит слишком странным + этот инструмент работает до невозможности медленно (а иногда благополучно лежит). [overpass-turbo](https://overpass-turbo.eu/)\n\nНо можно пойти куда **более простым и понятным** путём:\n\n1. Скачать дамп всех данных *OSM* (или маленький кусочек нужной нам территории)\n2. Отфильтровать объекты (оставить только те типы объектов, которые нам нужны)\n3. Преобразовать в формат, который пригоден для загрузки в БД\n\n## Небольшая вставка теории:\nЧтобы придумать, как вытащить железнодорожные станции, нужно понимать, какие данные и с какой структурой там в принципе есть. \n\nЕсть очень хорошая [вводная статья на хабре](https://habr.com/ru/post/146503/).<br>\nА также имеется [официальная дока](https://wiki.openstreetmap.org/wiki/Map_Features).\n\n**Если кратко:**\n\nДамп данных из *OpenStreetMap* можно представить в виде здоровенного XML файла, который содержит в себе ~~помойку~~ большое скопление тэгов трёх типов:\n\n1. Точки (**node**)\n2. Линии (**way**)\n3. Отношения (**relation**)\n\nВнутри этих тэгов заполняется всякая информация о них в виде **key:value**.\n\n**Например:**\nДавайте попробуем найти в интерфейсе *OSM* любую станцию и посмотреть, что там внутри.\n\nСтанция **Шушары** и её информация (слева в таблице):\n\n![Станция Шушары в интерфейсе](/assets/blog/exporting_data_form_osm/shushary.png)\n\nТеперь посмотрим, как она выглядит в данных:\n```xml\n<node id=\"1377619868\" lat=\"59.8057985\" lon=\"30.3884693\" version=\"9\" timestamp=\"2019-05-08T05:34:15Z\" changeset=\"70007449\" uid=\"474169\" user=\"Yevgeny Gromov\">\n    <tag k=\"esr:user\" v=\"033004\"/>\n    <tag k=\"name\" v=\"Шушары\"/>\n    <tag k=\"railway\" v=\"station\"/>\n    <tag k=\"uic_ref\" v=\"2005166\"/>\n    <tag k=\"wikidata\" v=\"Q4528146\"/>\n    <tag k=\"wikipedia\" v=\"ru:Шушары (станция)\"/>\n</node>\n```\n\nДанные хранятся в виде\n```xml\n<tag k=\"key\" v=\"value\"> \n```\nвнутри нашей точки *\"Шушары\"*. А координаты хранятся в атрибутах самого тега \"node\" (lat/lon).\n\nЗамечаем, что признак \"железнодорожная станция\" — это вот такой тэг. На него и будем ориентироваться, когда будем фильтровать данные:\n```xml\n<tag k=\"railway\" v=\"station\"/>\n```\n\nОкей, мы поняли структуру, поняли что нам надо. Но где данные, Лебовски?\n\n![Ваши данные будут храниться здесь](/assets/blog/exporting_data_form_osm/meme%20data.jpg)\n\n## Добываем данные\nЕсли у вас достаточно свободного пространства на жестком диске — можете попробовать выкачать весь мир [по официальным инструкциям](https://wiki.openstreetmap.org/wiki/Downloading_data).\n\nЛибо можно зайти на сайт [openStreetMap](https://www.openstreetmap.org/), открыть на карте нужный квадрат и нажать на \"Экспорт\".\n\n### У России другой путь\n**Проблема России в том**, что она достаточно большая, чтобы экспорт в интерфейсе *openStreetMap* **падал** из-за слишком большого количества данных, но всё ещё достаточно маленькая, чтобы ради неё выкачивать весь мир!\n\nСпециально для таких извращенцев, как мы, некоторые люди подготавливают \"нарезку\" мира на удобоваримые куски:\n\n* На [geofabrik.de](https://download.geofabrik.de/) имеются нарезки по континентам\n* На [needgeo.com](https://needgeo.com/) есть данные по странам пост-советского пространства.\n\nПоследняя ссылка как раз нам очень пригодится! :) Выкачиваем оттуда файл RU.pbf (который весит сущие копейки — всего **3GB**)\n\n## Обрабатываем данные\nДля обработки нам понадобятся две консольные утилиты: **osmconvert** и **osmfilter**.\n\nВ *debian/ubuntu* устанавливаются очень просто одной командой:\n```bash\nsudo apt install osmctools\n```\nДля остальных *ОС* имеются ссылки на бинарники на официальной wiki [Osmfilter](https://wiki.openstreetmap.org/wiki/Osmfilter) [Osmconvert](https://wiki.openstreetmap.org/wiki/Osmconvert).\n\nВо-первых, нам нужно распаковать скачанный файл **.pbf** в пригодный для фильтрации формат.\n```bash\nosmconvert RU.pbf -o=RU.o5m\n```\nНа выходе получим файл RU.o5m, который занимает уже 6.2GB. (но это всё ещё бинарный не человеко-читаемый файл.)\n\nТеперь отбрасываем всё лишнее, оставляя только точки с нужным там тегом (который мы нашли в предыдущих параграфах):\n```bash\nosmfilter RU.o5m --keep=\"railway=station\" > stations.osm\n```\nКомпьютер задумается на какое-то время, а затем заполнит файл *stations.osm*. Де-факто, уже почти всё. Мы на выходе получили *XML* файл со всеми нужными нам станциями (3Mb). \n\n**Попробуем проверить данные:**\nОткрываем в любом текстовом редакторе, который способен открывать большие текстовые файлы (vim), и бегло просматриваем станции:\n\nИ тут натыкаемся на станцию метро \"Озерки\". Что ж, формально — это жд, и формально — станция. Но не совсем то, что мне нужно. :)\n\n```xml\n<node id=\"96459081\" lat=\"60.0354511\" lon=\"30.3210663\" version=\"24\" timestamp=\"2020-01-08T22:53:32Z\" changeset=\"79358758\" uid=\"217225\" user=\"&#38;ergio\">\n    <tag k=\"colour\" v=\"blue\"/>\n    <tag k=\"layer\" v=\"-5\"/>\n    <tag k=\"name\" v=\"Озерки\"/>\n    <tag k=\"name:de\" v=\"Oserki\"/>\n    <tag k=\"name:en\" v=\"Ozerki\"/>\n    <tag k=\"name:fi\" v=\"Ozerki\"/>\n    <tag k=\"name:ru\" v=\"Озерки\"/>\n    <tag k=\"network\" v=\"Петербургский метрополитен\"/>\n    <tag k=\"operator\" v=\"Петербургский метрополитен\"/>\n    <tag k=\"public_transport\" v=\"station\"/>\n    <tag k=\"railway\" v=\"station\"/>\n    <tag k=\"station\" v=\"subway\"/>\n    <tag k=\"subway\" v=\"yes\"/>\n    <tag k=\"transport\" v=\"subway\"/>\n    <tag k=\"wikidata\" v=\"Q2241386\"/>\n    <tag k=\"wikipedia\" v=\"ru:Озерки (станция метро)\"/>\n</node>\n```\n\nВидим там целых три тега, которые свидетельствуют о том, что это метро. (зачем такая избыточность?)\n```xml\n<tag k=\"station\" v=\"subway\"/>\n<tag k=\"subway\" v=\"yes\"/>\n<tag k=\"transport\" v=\"subway\"/>\n```\nФильтруем по этим тегам:\n```bash\nosmfilter stations.osm --drop=\"station=subway or subway=yes or transport=subway\" > not_subway.osm\n```\n\nСмотрим на выходной файл — выглядит так, словно успешно отфильтровали. Теперь осталось превратить xml файл в CSV, чтобы удобно залить в базу.\n\nСмотрим на документацию по станциям и составляем список тегов, которые будем выводить в CSV:\n[railway:stations](https://wiki.openstreetmap.org/wiki/RU:Tag:railway%3Dstation)\n\n**Нужные нам столбцы:** \n\n1. id\n2. lat\n3. lon\n4. name\n5. uic_ref — уникальный код железнодорожной станции, присваиваемый UIC (International Union of Railways, Международный союз железных дорог).\n6. esr:user — уникальный код железнодорожной станции в Единой сетевой разметке (ЕСР, для станций Балтики и стран СНГ).\n\nЭкспортируем (обратите внимание, что атрибуты самого *node* записываются через \"@\"):\n```bash\nosmconvert not_subway.osm --all-to-nodes --csv=\"@id @lat @lon name uic_ref esr:user\" --csv=headline > stations.csv\n```\n\nТеперь мы можем со спокойной совестью делать с этими данными, что душе угодно. Можем обрабатывать руками в *EXCEL*, можем залить в базу и использовать в своих разнообразных проектах. \n\nЕсли найдете какие-то неточности в данных, очень рекомендуется исправить их не только у себя, а залить их также на саму *OpenStreetMap*. Так сказать, сделать свой маленький вклад в общее дело. :)\n\n\nP.S. Мистическим образом, под железнодорожные станции ещё мимикрирует Волгоградский метротрам. Но его уже можно отфильтровать в итоговом CSV.\n\n<iframe frameborder=\"0\" style=\"border:none;width:100%;height:180px;\" width=\"100%\" height=\"180\" src=\"https://music.yandex.ru/iframe/#track/31840941/3867842\">Слушайте <a href='https://music.yandex.ru/album/3867842/track/31840941'>У трамвая жизнь кривая. норвежская свекла</a>  —  <a href='https://music.yandex.ru/artist/3976133'>Ремонт Воды</a> на Яндекс.Музыке</iframe>\n\n[Итоговый CSV файл со станциями здесь.](/assets/blog/exporting_data_form_osm/stations.csv)\n\n#танцы_с_бубном #работа_с_данными","ogImage":{"url":"/assets/blog/exporting_data_form_osm/background.jpg"},"coverImage":"/assets/blog/exporting_data_form_osm/background.jpg","issueId":"12","excerpt":"Иногда возникает ситуация, в которой нам жизненно необходимо получить структурированные геоданные для своих проектов. Можно, конечно, долго собирать данные руками, а можно обратиться к прекрасным открытым базам данных."}],"tag":"работа_с_данными"},"__N_SSG":true}